<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Viaje a las Sierras üèîÔ∏è | 8 de Febrero</title>
    <style>
      :root {
        --summer-yellow: #fff3b0;
        --summer-orange: #ff6b35;
        --summer-blue: #5da9e9;
        --summer-green: #6a994e;
      }
      body {
        font-family: "Comic Neue", cursive;
        background: linear-gradient(45deg, #fff3b0, #ffd6ff);
        margin: 0;
        padding: 20px;
        color: #2f3e46;
      }
      .container {
        max-width: 500px;
        margin: 0 auto;
      }
      .title {
        text-align: center;
        color: var(--summer-orange);
        font-size: 1.8em;
        margin-bottom: 20px;
        text-shadow: 2px 2px 0px white;
      }
      .cars {
        background: white;
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .category-tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 15px;
      }
      .tab {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 10px;
        background: var(--summer-blue);
        color: white;
        font-family: inherit;
        cursor: pointer;
        transition: background 0.3s;
      }
      .tab:hover {
        background: var(--summer-green);
      }
      .active-tab {
        background: var(--summer-orange);
      }
      .form-container {
        background: white;
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      input,
      select,
      button {
        width: 100%;
        padding: 10px;
        margin: 5px 0;
        border: 2px solid var(--summer-green);
        border-radius: 8px;
        box-sizing: border-box;
      }
      button {
        background: var(--summer-green);
        color: white;
        border: none;
        font-weight: bold;
        cursor: pointer;
      }
      button:hover {
        background: var(--summer-orange);
      }
      .item-list {
        background: white;
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .item {
        padding: 10px;
        margin: 10px 0;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .item div:first-child {
        max-width: 65%;
      }
      .item-actions button {
        margin-left: 5px;
        padding: 5px 10px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
      }
      .item-actions button:hover {
        opacity: 0.8;
      }
      .total {
        font-weight: bold;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 2px dashed var(--summer-orange);
      }
      .reminders {
        background: #ffd6a5;
        padding: 15px;
        border-radius: 15px;
        margin: 20px 0;
        border: 2px dashed var(--summer-orange);
      }
      .accordion {
        border: 1px solid var(--summer-blue);
        border-radius: 8px;
        margin-bottom: 10px;
        overflow: hidden;
      }
      .accordion-header {
        background: var(--summer-green);
        padding: 10px;
        cursor: pointer;
        color: white;
        font-weight: bold;
        transition: background 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .accordion-header:hover {
        background: var(--summer-orange);
      }
      .accordion-content {
        display: none;
        padding: 10px;
        background: white;
      }
      .accordion-content.active {
        display: block;
      }
      .purchase-item {
        margin: 5px 0;
      }
      .accordion-button {
        background: var(--summer-blue);
        color: white;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
        text-align: left;
        transition: background 0.3s;
      }
      .accordion-button:hover {
        background: var(--summer-green);
      }
      .total-section {
        margin-top: 20px;
        padding: 15px;
        background: var(--summer-yellow);
        border-radius: 10px;
        border: 2px dashed var(--summer-orange);
      }
      .division-section {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px solid var(--summer-blue);
      }
      .user-balance {
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
    </style>

    <!-- Incluir Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCmM2Sj7_MVEDDaX-Ob1iUizHzm3Nuln00",
        authDomain: "sierras-6809e.firebaseapp.com",
        databaseURL: "https://sierras-6809e-default-rtdb.firebaseio.com",
        projectId: "sierras-6809e",
        storageBucket: "sierras-6809e.appspot.com",
        messagingSenderId: "1034904937452",
        appId: "1:1034904937452:web:16106c7997cb5638b216c9",
        measurementId: "G-X6PQ8XKPX2",
      };

      const app = firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      let currentCategory = "comida";
      let editingId = null;

      const users = {
        Gabi: { color: "#ffadad", icon: "üê±" },
        Jere: { color: "#a0c4ff", icon: "üê∂" },
        Eber: { color: "#bdb2ff", icon: "ü¶ä" },
        Eva: { color: "#fdffb6", icon: "üê∞" },
        Carito: { color: "#caffbf", icon: "üêª" },
        Josefina: { color: "#ffd6a5", icon: "üêØ" },
        Aldi: { color: "#ffc6ff", icon: "üêß" },
      };

      function showCategory(category, e) {
        currentCategory = category;
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active-tab"));
        if (e) e.target.classList.add("active-tab");
        renderForm();
        drawItems();
      }

      function renderForm() {
        const formHTML =
          currentCategory === "nafta"
            ? `
                <select id="carSelect">
                  <option value="Josefina">üöó Auto de Josefina</option>
                  <option value="Aldi">üöô Auto de Aldi</option>
                </select>
                <input type="number" id="naftaPrice" placeholder="Monto gastado $" />
                <button onclick="saveItem()" id="saveButton">Guardar ‚õΩ</button>
              `
            : `
                <select id="userSelect">
                  <option value="" disabled selected>Eleg√≠ tu nombre o qui√©n sos</option>
                  ${Object.entries(users)
                    .map(
                      ([name, data]) => `
                        <option value="${name}" style="background: ${data.color}">
                          ${data.icon} ${name}
                        </option>
                      `
                    )
                    .join("")}
                </select>
                <input type="text" id="itemDesc" placeholder="¬øQu√© compr√≥?" />
                <input type="number" id="itemPrice" placeholder="Precio $" />
                <button onclick="saveItem()" id="saveButton">Agregar üêæ</button>
              `;

        document.getElementById("dynamicForm").innerHTML = formHTML;
      }

      function saveItem() {
        const itemData = {
          categoria: currentCategory,
          nombre:
            currentCategory === "nafta"
              ? document.getElementById("carSelect").value
              : document.getElementById("userSelect").value,
          item:
            currentCategory === "nafta"
              ? document.getElementById("naftaPrice").value
              : document.getElementById("itemDesc").value,
          precio: parseFloat(
            currentCategory === "nafta"
              ? document.getElementById("naftaPrice").value
              : document.getElementById("itemPrice").value
          ),
          ...users[
            currentCategory === "nafta"
              ? document.getElementById("carSelect").value
              : document.getElementById("userSelect").value
          ],
        };

        if (editingId) {
          database
            .ref(`gastos/${editingId}`)
            .update(itemData)
            .then(() => drawItems());
          editingId = null;
          document.getElementById("saveButton").textContent =
            currentCategory === "nafta" ? "Guardar ‚õΩ" : "Agregar üêæ";
        } else {
          database
            .ref("gastos")
            .push(itemData)
            .then(() => drawItems());
        }
        clearForm();
      }

      function editItem(id) {
        database.ref(`gastos/${id}`).once("value", (snapshot) => {
          const item = snapshot.val();
          if (currentCategory === "nafta") {
            document.getElementById("carSelect").value = item.nombre;
            document.getElementById("naftaPrice").value = item.precio;
          } else {
            document.getElementById("userSelect").value = item.nombre;
            document.getElementById("itemDesc").value = item.item;
            document.getElementById("itemPrice").value = item.precio;
          }
          editingId = id;
          document.getElementById("saveButton").textContent = "Actualizar üêæ";
        });
      }

      function deleteItem(id) {
        database
          .ref(`gastos/${id}`)
          .remove()
          .then(() => drawItems());
      }

      function clearForm() {
        if (currentCategory === "nafta") {
          document.getElementById("naftaPrice").value = "";
        } else {
          document.getElementById("userSelect").selectedIndex = 0;
          document.getElementById("itemDesc").value = "";
          document.getElementById("itemPrice").value = "";
        }
      }

      function drawItems() {
        database.ref("gastos").once("value", (snapshot) => {
          const data = snapshot.val() || {};
          let html = '<div class="item-list">';
          const purchasesByUser = {};

          Object.entries(data).forEach(([id, item]) => {
            if (item.categoria === currentCategory) {
              html += `
                <div class="item" style="background: ${item.color}40">
                  <div>
                    ${item.icon} 
                    <strong>${item.nombre}</strong><br>
                    ${item.item} (${item.categoria})
                  </div>
                  <div>
                    $${item.precio.toFixed(2)}
                    <div class="item-actions">
                      <button onclick="editItem('${id}')">‚úèÔ∏è</button>
                      <button onclick="deleteItem('${id}')">üóëÔ∏è</button>
                    </div>
                  </div>
                </div>
              `;
            }

            if (!purchasesByUser[item.nombre]) {
              purchasesByUser[item.nombre] = [];
            }
            purchasesByUser[item.nombre].push(item);
          });

          html += "</div>";
          document.getElementById("content").innerHTML = html;
          updatePurchaseList(purchasesByUser);
        });
      }

      function updatePurchaseList(purchasesByUser) {
        let purchaseHtml = `
          <button class="accordion-button" onclick="toggleAccordion()">Lista de Compras</button>
          <div class="accordion-content" id="purchaseAccordion" style="display: none;">
        `;

        let grandTotal = 0;
        const userTotals = {};

        for (const [user, items] of Object.entries(purchasesByUser)) {
          const userTotal = items.reduce((acc, item) => acc + item.precio, 0);
          userTotals[user] = userTotal;
          grandTotal += userTotal;

          purchaseHtml += `
            <div class="accordion">
              <div class="accordion-header">
                <strong>${users[user].icon} ${user}</strong>
                <span>Total: $${userTotal.toFixed(2)}</span>
              </div>
              <div class="accordion-content">
                ${items
                  .map(
                    (item) => `
                  <div class="purchase-item">
                    <span>${item.item}</span> - 
                    <span>$${item.precio.toFixed(2)}</span> 
                    (${item.categoria})
                  </div>
                `
                  )
                  .join("")}
              </div>
            </div>
          `;
        }

        const numUsers = Object.keys(users).length;
        const perPerson = grandTotal / numUsers;

        purchaseHtml += `
          </div>
          <div class="total-section">
            <h3>üí∞ Total General: $${grandTotal.toFixed(2)}</h3>
          </div>
          <div class="division-section">
            <h3>üßÆ Divisi√≥n entre ${numUsers} personas:</h3>
            <p>‚úÖ Cada uno debe aportar: $${perPerson.toFixed(2)}</p>
            ${Object.entries(userTotals)
              .map(
                ([user, total]) => `
              <div class="user-balance" style="background: ${
                users[user].color
              }40">
                <div>
                  ${users[user].icon} ${user}<br>
                  <small>Aportado: $${total.toFixed(2)}</small>
                </div>
                <div style="text-align: right;">
                  ${total >= perPerson ? "‚ö° Sobrante:" : "üï≥Ô∏è Debe:"}<br>
                  <strong>$${Math.abs(total - perPerson).toFixed(2)}</strong>
                </div>
              </div>
            `
              )
              .join("")}
          </div>
        `;

        document.getElementById("purchaseList").innerHTML = purchaseHtml;

        const headers = document.querySelectorAll(".accordion-header");
        headers.forEach((header) => {
          header.addEventListener("click", () => {
            header.nextElementSibling.classList.toggle("active");
          });
        });
      }

      function toggleAccordion() {
        const accordionContent = document.getElementById("purchaseAccordion");
        accordionContent.style.display =
          accordionContent.style.display === "none" ? "block" : "none";
      }

      renderForm();
      drawItems();
      database.ref("gastos").on("value", drawItems);
    </script>
  </head>
  <body>
    <div class="container">
      <h1 class="title">üèîÔ∏è Viaje a las Sierras üê±<br />8 de Febrero</h1>
      <div class="cars">
        üöó Auto de Josefina: Gabi, Jere y Eber<br />
        üöô Auto de Aldi: Eva y Carito
      </div>
      <div class="reminders">
        <strong>üìå Recordatorios:</strong><br />
        ‚úÖ 1 Botella de agua grande por persona<br />
        üßä 1 Botella de hielo<br />
        ‚òÄÔ∏è Protector solar<br />
        üé≤ Juegos de mesa<br />
        üî¶ Linternas
      </div>
      <div class="category-tabs">
        <button class="tab active-tab" onclick="showCategory('comida', event)">
          üçî Comida
        </button>
        <button class="tab" onclick="showCategory('bebidas', event)">
          ü•§ Bebidas
        </button>
        <button class="tab" onclick="showCategory('nafta', event)">
          ‚õΩ Combustible
        </button>
        <button class="tab" onclick="showCategory('otros', event)">
          üéí Otros
        </button>
      </div>
      <div class="form-container" id="dynamicForm"></div>
      <div id="content"></div>
      <div id="purchaseList" class="form-container"></div>
    </div>
  </body>
</html>
